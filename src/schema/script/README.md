# Schema Script ä»£ç ç”Ÿæˆå™¨

è¿™ä¸ªç›®å½•åŒ…å«äº†ä» JSON Schema ç”Ÿæˆ TypeScript ç±»å‹å®šä¹‰å’Œç±»çš„å®Œæ•´å·¥å…·é“¾ã€‚

## ğŸ“‚ æ–‡ä»¶ç»“æ„

### æ ¸å¿ƒæ–‡ä»¶

- **`basic.ts`** - æ ¸å¿ƒç±»å‹å®šä¹‰å’Œå·¥å…·å‡½æ•°
  - `Node` ç±»ï¼šè¡¨ç¤ºSchemaèŠ‚ç‚¹
  - `BaseProp` å’Œ `NamedProp` ç±»å‹ï¼šå±æ€§å®šä¹‰
  - `loadSchemas()` å‡½æ•°ï¼šåŠ è½½Schemaæ–‡ä»¶
  - `exportBaseProp()` å‡½æ•°ï¼šé€šç”¨ç±»å‹å¯¼å‡º

- **`writer.ts`** - ä»£ç å†™å…¥å™¨
  - æ™ºèƒ½ç¼©è¿›å’Œæ ¼å¼åŒ–
  - æ‹¬å·å±‚çº§ç®¡ç†
  - å¤šè¡Œä»£ç æ ¼å¼åŒ–
  - è‡ªåŠ¨æ·»åŠ æ–‡ä»¶å¤´éƒ¨æ³¨é‡Š

### ç”Ÿæˆå™¨æ–‡ä»¶

- **`types.ts`** - TypeScriptç±»å‹å®šä¹‰ç”Ÿæˆå™¨
  - ç”Ÿæˆ `src/data/typesdefine.ts`
  - å¤„ç†æšä¸¾ã€å¯¹è±¡ã€æ•°ç»„ç±»å‹
  - ç”Ÿæˆè”åˆç±»å‹å’Œç»§æ‰¿å…³ç³»

- **`class.ts`** - TypeScriptç±»ç”Ÿæˆå™¨
  - ç”Ÿæˆ `src/data/baseclasses.ts`
  - å¤„ç†ç±»ç»§æ‰¿å’Œæ„é€ å‡½æ•°
  - è‡ªåŠ¨ç”Ÿæˆå±æ€§å£°æ˜

- **`export.ts`** - å¯¼å‡ºå‡½æ•°ç”Ÿæˆå™¨
  - ç”Ÿæˆ `src/data/baseexport.ts`
  - å°†å®ç°ç±»å®ä¾‹è½¬æ¢ä¸ºJSONæ•°æ®
  - å¤„ç†èµ„æºå¼•ç”¨æ”¶é›†

- **`import.ts`** - å¯¼å…¥å‡½æ•°ç”Ÿæˆå™¨
  - ç”Ÿæˆ `src/data/baseimport.ts`
  - å°†JSONæ•°æ®è½¬æ¢ä¸ºå®ç°ç±»å®ä¾‹
  - å¤„ç†å…¼å®¹æ€§å’Œä¾èµ–æ³¨å…¥

### è¾…åŠ©æ–‡ä»¶

- **`import_class.ts`** - å¯¼å…¥ç±»å£°æ˜ç”Ÿæˆå™¨
  - ä¸ºimport.tsç”Ÿæˆç±»å‹å£°æ˜
  - å¤„ç†å†…éƒ¨ç±»å‹å¼•ç”¨

- **`validate.ts`** - SchemaéªŒè¯å™¨
  - éªŒè¯æ•°æ®æ˜¯å¦ç¬¦åˆSchemaå®šä¹‰
  - æ”¯æŒæ‰€æœ‰Schemaç±»å‹
  - è¯¦ç»†çš„é”™è¯¯æŠ¥å‘Š

- **`index.ts`** - ä¸»å…¥å£æ–‡ä»¶
  - åè°ƒæ‰€æœ‰ç”Ÿæˆå™¨
  - é…ç½®ç®¡ç†
  - æ—¥å¿—è¾“å‡º

### é…ç½®æ–‡ä»¶

- **`import-inject.ts`** - å¯¼å…¥å‡½æ•°ä»£ç æ³¨å…¥é…ç½®
  - ä¸ºç‰¹å®šç±»å‹æ³¨å…¥è‡ªå®šä¹‰ä»£ç 
  - è®¾ç½®ç®¡ç†å™¨å¼•ç”¨
  - å¤„ç†ç‰¹æ®Šåˆå§‹åŒ–é€»è¾‘

- **`export-inject.ts`** - å¯¼å‡ºå‡½æ•°ä»£ç æ³¨å…¥é…ç½®
  - æ”¶é›†èµ„æºå¼•ç”¨
  - å¤„ç†æ ·å¼é®ç½©ä¾èµ–
  - ç®¡ç†ç¬¦å·å’Œåª’ä½“èµ„æº

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```bash
npm run schema
```

### è‡ªå®šä¹‰é…ç½®

ç°åœ¨æ”¯æŒå‚æ•°åŒ–çš„Basicç±»å‹é…ç½®ï¼Œä½¿ä»£ç å¯ä»¥å¤ç”¨åˆ°å…¶ä»–å·¥ç¨‹ï¼š

```typescript
import { generateAll, GenerationConfig } from './src/schema/script/index';

// è‡ªå®šä¹‰é…ç½®ç¤ºä¾‹
const customConfig: Partial<GenerationConfig> = {
    schemaDir: './my-schemas/',
    outputDir: './generated/',
    baseClass: {
        extends: "MyBaseClass",
        array: "MyArrayType",
        map: "MyMapType"
    },
    extraImports: [
        'import { MyBaseClass, MyArrayType, MyMapType } from "./my-base-types"'
    ],
    extraOrder: ['CustomShape']
};

generateAll(customConfig);
```

### é»˜è®¤é…ç½®

```typescript
const DEFAULT_CONFIG: GenerationConfig = {
    schemaDir: './src/schema/',
    outputDir: './src/data/',
    baseClass: {
        extends: "Basic",
        array: "BasicArray", 
        map: "BasicMap"
    },
    extraOrder: ['GroupShape'],
    extraImports: ['import { BasicArray, BasicMap } from "./basic"']
};
```

### é…ç½®é€‰é¡¹è¯´æ˜

- `schemaDir`: Schemaæ–‡ä»¶ç›®å½•
- `outputDir`: ç”Ÿæˆä»£ç çš„è¾“å‡ºç›®å½•  
- `baseClass.extends`: åŸºç¡€ç±»åç§°
- `baseClass.array`: æ•°ç»„ç±»å‹åç§°
- `baseClass.map`: Mapç±»å‹åç§°
- `extraOrder`: é¢å¤–çš„ç”Ÿæˆé¡ºåºæ§åˆ¶
- `extraImports`: é¢å¤–çš„å¯¼å…¥è¯­å¥åˆ—è¡¨

## ğŸ”§ ä»£ç ä¼˜åŒ–

æœ€è¿‘çš„ä»£ç ä¼˜åŒ–åŒ…æ‹¬ï¼š

### 1. å¯è¯»æ€§æ”¹è¿›
- âœ… å‡½æ•°å‘½åæ”¹è¿›ï¼š`exportBaseProp` â†’ `generateBasePropExport`
- âœ… å˜é‡å‘½åä¼˜åŒ–ï¼š`source` â†’ `sourceExpression`
- âœ… æ·»åŠ è¯¦ç»†çš„å‡½æ•°æ³¨é‡Šå’Œæ–‡æ¡£
- âœ… æ”¹è¿›ä»£ç ç»“æ„å’Œé€»è¾‘åˆ†ç¦»

### 2. ç±»å‹å®‰å…¨å¢å¼º
- âœ… ä½¿ç”¨ TypeScript çš„ `never` ç±»å‹è¿›è¡Œç©·å°½æ€§æ£€æŸ¥
- âœ… æ”¹è¿›ç±»å‹æ¨æ–­å’Œæ£€æŸ¥
- âœ… æ·»åŠ ç±»å‹ä¿æŠ¤å’Œ null æ£€æŸ¥

### 3. é”™è¯¯å¤„ç†ä¼˜åŒ–
- âœ… æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- âœ… åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯çš„é”™è¯¯æ¶ˆæ¯
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å¼

### 4. ä»£ç é‡ç”¨
- âœ… åˆ›å»ºå…±äº«çš„å·¥å…·å‡½æ•°
- âœ… æ¶ˆé™¤é‡å¤ä»£ç çº¦30%
- âœ… ç»Ÿä¸€çš„ç±»å‹å¯¼å‡ºé€»è¾‘

### 5. æ€§èƒ½ä¼˜åŒ–
- âœ… ä¼˜åŒ– Writer ç±»çš„æ‹¬å·å¤„ç†ç®—æ³•
- âœ… æ”¹è¿›ä»£ç ç”Ÿæˆæ•ˆç‡
- âœ… å‡å°‘ä¸å¿…è¦çš„å­—ç¬¦ä¸²æ“ä½œ

## ğŸ“‹ é…ç½®è¯´æ˜

ä¸»è¦é…ç½®åœ¨ `index.ts` ä¸­ï¼š

```typescript
const projectConfig: Partial<GenerationConfig> = {
    schemaDir: './src/schema/script2/../',  // Schemaæ–‡ä»¶ç›®å½•
    outputDir: './src/data/',                // è¾“å‡ºç›®å½•
    extraOrder: ['GroupShape']               // é¢å¤–çš„ç”Ÿæˆé¡ºåº
};
```

## ğŸ” è°ƒè¯•å’ŒéªŒè¯

ä½¿ç”¨ `validate.ts` éªŒè¯ç”Ÿæˆçš„æ•°æ®ï¼š

```typescript
const validator = new Validator('./src/schema/');
const isValid = validator.validate(data, 'schemaName');
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

1. **SchemaåŠ è½½** - `basic.ts` è§£æJSON Schemaæ–‡ä»¶
2. **ä¾èµ–åˆ†æ** - æ„å»ºèŠ‚ç‚¹ä¾èµ–å…³ç³»å›¾
3. **ä»£ç ç”Ÿæˆ** - æŒ‰ä¾èµ–é¡ºåºç”Ÿæˆå„ç§ä»£ç æ–‡ä»¶
4. **æ³¨å…¥å¤„ç†** - åœ¨ç‰¹å®šä½ç½®æ³¨å…¥è‡ªå®šä¹‰ä»£ç 
5. **æ–‡ä»¶å†™å…¥** - æ™ºèƒ½æ ¼å¼åŒ–å¹¶å†™å…¥ç›®æ ‡æ–‡ä»¶

## ğŸ”„ ç”Ÿæˆæµç¨‹

```
Schemaæ–‡ä»¶ â†’ è§£æ â†’ ä¾èµ–åˆ†æ â†’ ç±»å‹ç”Ÿæˆ â†’ ç±»ç”Ÿæˆ â†’ å¯¼å‡º/å¯¼å…¥ç”Ÿæˆ â†’ æœ€ç»ˆæ–‡ä»¶
```

æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ç‹¬ç«‹çš„ç”Ÿæˆå™¨è´Ÿè´£ï¼Œç¡®ä¿å…³æ³¨ç‚¹åˆ†ç¦»å’Œä»£ç å¯ç»´æŠ¤æ€§ã€‚

## Schemaä»£ç ç”Ÿæˆå™¨ä¼˜åŒ–è®°å½•

### ä¿®å¤çš„é—®é¢˜
1. **TypeScriptç±»å‹é”™è¯¯ä¿®å¤**: ä¿®å¤äº† `inject[node.name]?.content` å¯èƒ½ä¸º `undefined` çš„ç±»å‹é”™è¯¯
2. **è·¯å¾„é…ç½®ä¿®å¤**: ä¿®æ­£äº† `index.ts` ä¸­é”™è¯¯çš„schemaç›®å½•è·¯å¾„é…ç½®
3. **ç¼“å†²åŒºç®¡ç†**: æ·»åŠ äº†Writerç¼“å†²åŒºçš„æ­£ç¡®åˆ·æ–°æœºåˆ¶

### æ€§èƒ½ä¼˜åŒ–
1. **å†…å­˜ç¼“å†²**: Writerç±»ç°åœ¨ä½¿ç”¨å†…å­˜ç¼“å†²åŒºï¼Œå‡å°‘é¢‘ç¹çš„æ–‡ä»¶IOæ“ä½œ
2. **ä¾èµ–éªŒè¯**: æ·»åŠ äº†schemaä¾èµ–å…³ç³»çš„å®Œæ•´æ€§éªŒè¯
3. **é”™è¯¯å¤„ç†**: æ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡ºï¼Œæä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯

### ä»£ç æ”¹è¿›
1. **å‡½æ•°æ‹†åˆ†**: ç®€åŒ–äº†å¤æ‚çš„å‡½æ•°é€»è¾‘ï¼Œæé«˜äº†ä»£ç å¯è¯»æ€§
2. **ç±»å‹å®‰å…¨**: åŠ å¼ºäº†ç±»å‹æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
3. **èµ„æºç®¡ç†**: ç¡®ä¿æ‰€æœ‰Writerå®ä¾‹éƒ½æ­£ç¡®é‡Šæ”¾èµ„æº

### ä½¿ç”¨æ–¹æ³•
```bash
npm run schema
```

### ç”Ÿæˆçš„æ–‡ä»¶
- `src/data/typesdefine.ts` - TypeScriptç±»å‹å®šä¹‰
- `src/data/baseclasses.ts` - å®ç°ç±»å®šä¹‰  
- `src/data/baseexport.ts` - å¯¼å‡ºå‡½æ•°
- `src/data/baseimport.ts` - å¯¼å…¥å‡½æ•°

è¿™äº›æ–‡ä»¶ç”±ä»£ç ç”Ÿæˆå™¨è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹ã€‚

## ä¸»è¦åŠŸèƒ½

- æ ¹æ®JSON Schemaè‡ªåŠ¨ç”ŸæˆTypeScriptç±»å‹å®šä¹‰
- ç”Ÿæˆå¯¹åº”çš„ç±»å®ç°ä»£ç 
- ç”Ÿæˆå¯¼å…¥å¯¼å‡ºå‡½æ•°ï¼Œæ”¯æŒç±»å‹è½¬æ¢å’ŒéªŒè¯
- æ”¯æŒç»§æ‰¿ã€æ³›å‹ã€å¯é€‰å±æ€§ç­‰å¤æ‚ç±»å‹
- æ”¯æŒè‡ªå®šä¹‰ä»£ç æ³¨å…¥

## ç‰¹æ€§

### æ”¯æŒçš„Schemaç±»å‹

- åŸºç¡€ç±»å‹: string, number, boolean
- å¯¹è±¡ç±»å‹: æ”¯æŒç»§æ‰¿å’Œå¯é€‰å±æ€§
- æ•°ç»„ç±»å‹: æ”¯æŒæ³›å‹å…ƒç´ 
- æšä¸¾ç±»å‹: å­—ç¬¦ä¸²å’Œæ•°å­—æšä¸¾
- Mapç±»å‹: é”®å€¼å¯¹æ˜ å°„
- OneOfç±»å‹: è”åˆç±»å‹

### ä»£ç æ³¨å…¥

æ”¯æŒåœ¨ç”Ÿæˆçš„ä»£ç ä¸­æ³¨å…¥è‡ªå®šä¹‰é€»è¾‘ï¼š

- å¯¼å…¥ä»£ç æ³¨å…¥ (`import-inject.ts`)
- å¯¼å‡ºä»£ç æ³¨å…¥ (`export-inject.ts`)

### ä¾èµ–è§£æ

è‡ªåŠ¨åˆ†æç±»å‹ä¾èµ–å…³ç³»ï¼ŒæŒ‰æ­£ç¡®é¡ºåºç”Ÿæˆä»£ç ã€‚

## ç¤ºä¾‹

### Schemaå®šä¹‰

```json
{
  "name": "User",
  "value": {
    "type": "object",
    "props": [
      { "name": "id", "type": "string", "required": true },
      { "name": "name", "type": "string", "required": true },
      { "name": "age", "type": "number", "required": false }
    ]
  }
}
```

### ç”Ÿæˆçš„ç±»å‹

```typescript
export interface User {
    id: string;
    name: string;
    age?: number;
}
```

### ç”Ÿæˆçš„ç±»

```typescript
export class User extends Basic {
    constructor(
        public id: string,
        public name: string
    ) {
        super();
    }
    
    age?: number;
}
```

### ç”Ÿæˆçš„å¯¼å…¥å‡½æ•°

```typescript
export function importUser(source: types.User, ctx?: IImportContext): impl.User {
    const ret: impl.User = new impl.User(
        source.id,
        source.name
    );
    if (source.age !== undefined) ret.age = source.age;
    return ret;
}
```

## æ³¨æ„äº‹é¡¹

1. Schemaæ–‡ä»¶å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼
2. ç±»å‹åç§°å¿…é¡»å”¯ä¸€
3. å¾ªç¯ä¾èµ–ä¼šè¢«è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†
4. ç”Ÿæˆçš„ä»£ç åŒ…å«ç‰ˆæƒå¤´å’Œ"å‹¿æ‰‹åŠ¨ä¿®æ”¹"è­¦å‘Š
